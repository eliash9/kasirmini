<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kasir Mini</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="theme-color" content="#4f46e5" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" type="image/png" sizes="32x32" href="icons/ios/32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="icons/ios/16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="icons/ios/180.png" />
    <style>
      /* Receipt 58mm print styles */
      @media print {
        @page { size: 58mm auto; margin: 0; }
        body { margin: 0; background: #fff; }
        /* Print only the receipt */
        body * { visibility: hidden; }
        #receipt, #receipt * { visibility: visible; }
        #receipt { width: 58mm !important; border: none !important; box-shadow: none !important; position: absolute; left: 0; top: 0; }
        #receipt * { font-size: 11px; line-height: 1.35; }
        #receipt .title { font-size: 14px; font-weight: 700; }
      }
      /* Screen preview of 58mm receipt */
      #receipt { width: 58mm; background: #fff; }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-b from-indigo-300 via-white to-fuchsia-300 text-gray-900">
    <!-- App Loader Overlay -->
    <div id="app-loader" class="fixed inset-0 z-[100] flex items-center justify-center bg-gradient-to-br from-indigo-600 to-fuchsia-600 text-white">
      <div class="flex flex-col items-center gap-3">
        <div class="w-10 h-10 rounded-full border-4 border-white/40 border-t-white animate-spin" aria-hidden="true"></div>
        <div class="text-sm opacity-90">Memuat Kasir Miniâ€¦</div>
      </div>
    </div>

    <div id="app">
      <!-- Header with tabs -->
      <header class="no-print sticky top-0 z-10 bg-gradient-to-r from-indigo-600 to-fuchsia-600 text-white shadow">
        <div class="mx-auto max-w-3xl px-4 py-3">
          <div class="flex items-center justify-between">
            <h1 class="font-semibold tracking-wide">{{ storeName }}</h1>
            <div class="text-xs opacity-90">by eliash.el</div>
          </div>
          <div class="mt-3 flex gap-2 items-center">
            <button @click="activeTab='pos'" :class="activeTab==='pos' ? 'bg-white/90 text-gray-900' : 'bg-white/10 text-white hover:bg-white/20'" class="px-3 py-1 rounded flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l3-8H6.4M7 13l-1.293 2.293A1 1 0 007.618 17H19m-12 0a1 1 0 100 2 1 1 0 000-2zm12 0a1 1 0 110 2 1 1 0 010-2z"/></svg>
              <span class="hidden sm:inline">Kasir</span>
            </button>
            <button @click="activeTab='history'" :class="activeTab==='history' ? 'bg-white/90 text-gray-900' : 'bg-white/10 text-white hover:bg-white/20'" class="px-3 py-1 rounded flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span class="hidden sm:inline">Riwayat</span>
            </button>
            <button @click="activeTab='products'" :class="activeTab==='products' ? 'bg-white/90 text-gray-900' : 'bg-white/10 text-white hover:bg-white/20'" class="px-3 py-1 rounded flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h3l2 2h7a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V5z"/></svg>
              <span class="hidden sm:inline">Produk</span>
            </button>
            <button @click="showSettings=true" class="ml-auto px-3 py-1 rounded bg-white/10 text-white hover:bg-white/20 flex items-center gap-2" aria-label="Pengaturan">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11.983 1.574a1 1 0 00-1.966 0l-.117.586a1 1 0 01-.95.788l-.598.03a1 1 0 00-.905.62l-.232.561a1 1 0 01-.81.6l-.596.074a1 1 0 00-.827.727l-.157.587a1 1 0 01-.666.69l-.57.19a1 1 0 00-.62.905l.03.598a1 1 0 01-.788.95l-.586.117a1 1 0 000 1.966l.586.117a1 1 0 01.788.95l-.03.598a1 1 0 00.62.905l.57.19a1 1 0 01.666.69l.157.587a1 1 0 00.827.727l.596.074a1 1 0 01.81.6l.232.561a1 1 0 00.905.62l.598.03a1 1 0 01.95.788l.117.586a1 1 0 001.966 0l.117-.586a1 1 0 01.95-.788l.598-.03a1 1 0 00.905-.62l.232-.561a1 1 0 01.81-.6l.596-.074a1 1 0 00.827-.727l.157-.587a1 1 0 01.666-.69l.57-.19a1 1 0 00.62-.905l-.03-.598a1 1 0 01.788-.95l.586-.117a1 1 0 000-1.966l-.586-.117a1 1 0 01-.788-.95l.03-.598a1 1 0 00-.62-.905l-.57-.19a1 1 0 01-.666-.69l-.157-.587a1 1 0 00-.827-.727l-.596-.074a1 1 0 01-.81-.6l-.232-.561a1 1 0 00-.905-.62l-.598-.03a1 1 0 01-.95-.788l-.117-.586zM10 13a3 3 0 110-6 3 3 0 010 6z"/></svg>
              <span class="hidden sm:inline">Pengaturan</span>
            </button>
          </div>
        </div>
        <!-- First-run settings restore prompt -->
        <div v-if="showFirstRunImport" class="mx-auto max-w-3xl px-4 pb-3">
          <div class="mt-2 rounded-lg bg-amber-100 text-amber-900 p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div class="text-sm">Pertama kali pakai? Impor file pengaturan agar tidak perlu isi manual.</div>
            <div class="flex gap-2">
              <button @click="openImportSettingsPicker" class="px-3 py-1.5 rounded bg-amber-600 text-white">Impor Pengaturan (.json/.txt)</button>
              <button @click="showSettings=true" class="px-3 py-1.5 rounded bg-white text-amber-900">Isi Manual</button>
              <button @click="showFirstRunImport=false" class="px-3 py-1.5 rounded bg-amber-200 text-amber-900">Nanti</button>
            </div>
          </div>
        </div>
      </header>

      <!-- Main -->
      <main class="mx-auto max-w-3xl p-4">
        <!-- POS View -->
        <div v-if="activeTab==='pos'" class="space-y-4">
          <!-- Quick Products + Scan -->
          <section class="bg-white rounded-2xl shadow p-4">
            <div class="flex items-center gap-2 mb-3">
              <input v-model="productQuery" placeholder="Cari produk..." class="flex-1 border rounded-lg px-3 py-2" />
              <button @click="openScanner" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white flex items-center gap-2" aria-label="Scan barcode">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 4a1 1 0 011-1h3v2H5v2H3V4zm9-1h3a1 1 0 011 1v3h-2V5h-2V3zM4 15H3v3a1 1 0 001 1h3v-2H4v-2zm10 2h-2v2h3a1 1 0 001-1v-3h-2v2z"/></svg>
                <span class="hidden sm:inline">Scan</span>
              </button>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 max-h-44 overflow-auto">
              <button v-for="p in filteredProducts" :key="p.id" @click="addProductToCart(p)" class="border rounded-lg p-2 hover:bg-indigo-50 text-left">
                <div class="text-sm font-medium truncate">{{ p.name }}</div>
                <div class="text-xs text-gray-500">{{ formatIDR(p.price) }}</div>
              </button>
              <div v-if="filteredProducts.length===0" class="col-span-full text-xs text-gray-500">Tidak ada produk cocok.</div>
            </div>
          </section>

          <!-- Add Item (manual) -->
          <section class="bg-white rounded-2xl shadow p-4">
            <h2 class="font-semibold mb-3">Tambah Item</h2>
            <div class="grid grid-cols-1 sm:grid-cols-6 gap-2">
              <input v-model="newItem.name" type="text" placeholder="Nama item" class="sm:col-span-3 border rounded-lg px-3 py-2" />
              <input v-model.number="newItem.price" type="number" min="0" step="100" placeholder="Harga (Rp)" class="sm:col-span-2 border rounded-lg px-3 py-2" />
              <button @click="addItem" class="sm:col-span-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-3 py-2 flex items-center justify-center" aria-label="Tambah item">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"/></svg>
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Anda bisa memilih dari master produk atau input manual di sini.</p>
          </section>

          <!-- Cart -->
          <section class="bg-white rounded-2xl shadow p-4">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">Keranjang</h2>
              <button @click="clearCart" class="p-2 rounded hover:bg-red-50 disabled:opacity-50" :disabled="cart.length===0" aria-label="Kosongkan keranjang">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 100 2h.293l.853 10.24A2 2 0 007.14 18h5.72a2 2 0 001.994-1.76L15.707 6H16a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0010 2H9zm-1 6a1 1 0 012 0v7a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v7a1 1 0 11-2 0V8z" clip-rule="evenodd"/></svg>
              </button>
            </div>

            <div v-if="cart.length===0" class="text-sm text-gray-500">Belum ada item.</div>
            <div v-else class="divide-y">
              <div v-for="(it, idx) in cart" :key="idx" class="py-2 flex items-start gap-3">
                <div class="flex-1">
                  <div class="font-medium">{{ it.name }}</div>
                  <div class="text-xs text-gray-500">{{ formatIDR(it.price) }} Ã— {{ it.qty }}</div>
                </div>
                <div class="flex items-center gap-1">
                  <button class="p-2 rounded border hover:bg-gray-50" @click="decQty(idx)" aria-label="Kurangi">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z"/></svg>
                  </button>
                  <input type="number" min="1" v-model.number="it.qty" class="w-14 text-center border rounded px-2 py-1" />
                  <button class="p-2 rounded border hover:bg-gray-50" @click="incQty(idx)" aria-label="Tambah">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"/></svg>
                  </button>
                </div>
                <div class="w-28 text-right tabular-nums">{{ formatIDR(it.price * it.qty) }}</div>
                <button @click="removeItem(idx)" class="p-2 rounded hover:bg-red-50" aria-label="Hapus item">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.536-10.95a1 1 0 00-1.414-1.414L10 7.586 7.879 5.465A1 1 0 106.465 6.88L8.586 9l-2.121 2.121a1 1 0 101.414 1.415L10 10.414l2.121 2.122a1 1 0 001.415-1.415L11.414 9l2.122-2.121z" clip-rule="evenodd"/></svg>
                </button>
              </div>
            </div>

            <!-- Totals -->
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-2">
              <div class="p-3 bg-indigo-50 rounded">
                <div class="text-xs text-indigo-700">Subtotal</div>
                <div class="font-semibold tabular-nums">{{ formatIDR(subtotal) }}</div>
              </div>
              <div class="p-3 bg-rose-50 rounded">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-rose-700">Diskon (%)</div>
                    <input type="number" min="0" max="100" step="1" v-model.number="discountPct" class="mt-1 w-24 border rounded px-2 py-1" />
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-rose-700">Nilai</div>
                    <div class="font-semibold tabular-nums">-{{ formatIDR(discountAmount) }}</div>
                  </div>
                </div>
              </div>
              <div class="p-3 bg-amber-50 rounded">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-amber-700">Pajak (%)</div>
                    <input type="number" min="0" max="100" step="1" v-model.number="taxPct" class="mt-1 w-24 border rounded px-2 py-1" />
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-amber-700">Nilai</div>
                    <div class="font-semibold tabular-nums">{{ formatIDR(taxAmount) }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-4 flex items-center justify-between">
              <div class="text-lg font-semibold">Total: <span class="tabular-nums">{{ formatIDR(total) }}</span></div>
              <div class="flex gap-2">
                
                <button class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-white flex items-center gap-2 disabled:opacity-50" @click="openPayment" :disabled="cart.length===0">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2V8h-4a2 2 0 01-2-2V2H4zm8-2v4h4l-4-4z"/></svg>
                  <span class="hidden sm:inline">Bayar</span>
                </button>
              </div>
            </div>
          </section>
        </div>

      <!-- History View -->
      <div v-if="activeTab==='history'" class="space-y-4">
          <section class="bg-white rounded-2xl shadow p-4">
            <h2 class="font-semibold mb-3">Riwayat Transaksi</h2>
            <div class="grid grid-cols-1 sm:grid-cols-6 gap-2 mb-3">
              <div class="sm:col-span-2">
                <label class="text-xs text-gray-500">Tanggal awal</label>
                <input type="date" v-model="filterStart" class="w-full border rounded px-2 py-1" />
              </div>
              <div class="sm:col-span-2">
                <label class="text-xs text-gray-500">Tanggal akhir</label>
                <input type="date" v-model="filterEnd" class="w-full border rounded px-2 py-1" />
              </div>
              <div class="sm:col-span-1">
                <label class="text-xs text-gray-500">Metode</label>
                <select v-model="historyMethod" class="w-full border rounded px-2 py-1">
                  <option value="">Semua</option>
                  <option value="cash">Tunai</option>
                  <option value="qris">QRIS</option>
                  <option value="other">Lainnya</option>
                </select>
              </div>
              <div class="sm:col-span-1">
                <label class="text-xs text-gray-500">Cari</label>
                <input type="text" v-model.trim="historyQuery" placeholder="ID/produk/catatan" class="w-full border rounded px-2 py-1" />
              </div>
            </div>
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
              <div class="text-sm text-gray-700 flex flex-wrap gap-x-4 gap-y-1">
                <span><span class="text-gray-500">Transaksi:</span> {{ historySummary.count }}</span>
                <span><span class="text-gray-500">Omzet:</span> <span class="tabular-nums font-medium">{{ formatIDR(historySummary.total) }}</span></span>
                <span><span class="text-gray-500">Rata-rata:</span> <span class="tabular-nums">{{ formatIDR(historySummary.avg) }}</span></span>
              </div>
            <div class="flex gap-2">
                <button @click="exportHistoryCSV" class="px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-700 text-white text-sm">Ekspor CSV</button>
                <button @click="backupAllToSheet" class="px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-700 text-white text-sm" :disabled="!gsWebAppUrl || !gsSheetId">Backup ke Sheet</button>
                <button @click="restoreFromSheetUI" class="px-3 py-1.5 rounded bg-fuchsia-600 hover:bg-fuchsia-700 text-white text-sm" :disabled="!gsWebAppUrl || !gsSheetId">Restore dari Sheet</button>
                <button @click="resetHistoryFilters" class="px-3 py-1.5 rounded bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm">Reset</button>
              </div>
            </div>
            <div v-if="backupStatus" class="mb-2 text-xs" :class="backupStatusOk ? 'text-emerald-700' : 'text-rose-700'">{{ backupStatus }}</div>
            <div class="divide-y">
              <div v-for="tx in filteredHistory" :key="tx.id" class="py-2 flex items-center justify-between">
                <div>
                  <div class="text-sm">{{ formatDateTime(tx.date) }}</div>
                  <div class="text-xs text-gray-500">{{ tx.items.length }} item â€¢ {{ paymentLabel(tx.paymentMethod) }}</div>
                </div>
                <div class="text-right">
                  <div class="font-medium tabular-nums">{{ formatIDR(tx.total) }}</div>
                  <div class="flex gap-2 justify-end">
                    <button class="px-2 py-1 rounded bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-xs" @click="loadReceipt(tx); showReceiptModal=true; activeTab='pos'">Lihat Struk</button>
                  </div>
                </div>
              </div>
              <div v-if="filteredHistory.length===0" class="py-6 text-center text-sm text-gray-500">Tidak ada transaksi untuk filter saat ini.</div>
            </div>
          </section>
        </div>
        <!-- Products (Master) View -->
      <div v-if="activeTab==='products'" class="space-y-4">
        <section class="bg-white rounded-2xl shadow p-4">
          <h2 class="font-semibold mb-3">Master Produk</h2>
          <div class="flex flex-wrap gap-2 mb-3">
            <button @click="exportProductsJSON" class="px-3 py-1.5 rounded border">Ekspor Produk (.json)</button>
            <div>
              <input id="import-products-input" type="file" accept="application/json" class="hidden" @change="importProductsJSON" />
              <button @click="() => document.getElementById('import-products-input').click()" class="px-3 py-1.5 rounded border">Impor Produk (.json)</button>
            </div>
            <button @click="backupProductsToSheet" class="px-3 py-1.5 rounded bg-indigo-600 text-white disabled:opacity-50" :disabled="!gsWebAppUrl || !gsSheetId">Backup Produk ke Sheet</button>
            <button @click="restoreProductsFromSheetUI" class="px-3 py-1.5 rounded bg-fuchsia-600 text-white disabled:opacity-50" :disabled="!gsWebAppUrl || !gsSheetId">Restore Produk dari Sheet</button>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-6 gap-2">
            <input v-model="newProduct.name" placeholder="Nama produk" class="sm:col-span-2 border rounded px-3 py-2" />
            <input v-model.number="newProduct.price" type="number" min="0" step="100" placeholder="Harga (Rp)" class="sm:col-span-2 border rounded px-3 py-2" />
            <input v-model="newProduct.barcode" placeholder="Barcode (opsional)" class="sm:col-span-1 border rounded px-3 py-2" />
            <button @click="saveProduct" class="sm:col-span-1 rounded bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2">Simpan</button>
          </div>
        </section>
        <section class="bg-white rounded-2xl shadow p-4">
          <h3 class="font-semibold mb-3">Daftar Produk</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-80 overflow-auto">
            <div v-for="p in products" :key="p.id" class="border rounded p-3 flex items-center justify-between">
              <div>
                <div class="font-medium">{{ p.name }}</div>
                <div class="text-xs text-gray-500">{{ formatIDR(p.price) }} â€¢ {{ p.barcode || 'â€”' }}</div>
              </div>
              <div class="flex gap-2">
                <button class="px-2 py-1 rounded border" @click="editProduct(p)">Edit</button>
                <button class="px-2 py-1 rounded border text-red-600" @click="deleteProduct(p.id)">Hapus</button>
              </div>
            </div>
            <div v-if="products.length===0" class="text-xs text-gray-500">Belum ada produk.</div>
          </div>
        </section>
      </div>

        <!-- PaymentModal -->
        <div v-if="showPayment" class="no-print fixed inset-0 z-30 flex items-center justify-center bg-black/50 p-4">
          <div class="bg-white rounded-xl shadow p-4 w-full max-w-sm">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">Pembayaran</h3>
              <button @click="showPayment=false" class="p-2 rounded hover:bg-gray-100" aria-label="Tutup">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.536-10.95a1 1 0 00-1.414-1.414L10 7.586 7.879 5.465A1 1 0 106.465 6.88L8.586 9l-2.121 2.121a1 1 0 101.414 1.415L10 10.414l2.121 2.122a1 1 0 001.415-1.415L11.414 9l2.122-2.121z" clip-rule="evenodd"/></svg>
              </button>
            </div>
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>Total</div>
                <div class="font-semibold tabular-nums">{{ formatIDR(total) }}</div>
              </div>

              <!-- Payment method selector -->
              <div>
                <div class="text-sm text-gray-500 mb-1">Metode Pembayaran</div>
                <div class="grid grid-cols-3 gap-2">
                  <button @click="paymentMethod='cash'" :class="paymentMethod==='cash' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'" class="px-3 py-2 rounded">Tunai</button>
                  <button @click="paymentMethod='qris'" :class="paymentMethod==='qris' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'" class="px-3 py-2 rounded">QRIS</button>
                  <button @click="paymentMethod='other'" :class="paymentMethod==='other' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'" class="px-3 py-2 rounded">Lainnya</button>
                </div>
              </div>

              <!-- Cash input + quick denominations -->
              <div v-if="paymentMethod==='cash'" class="space-y-2">
                <div>
                  <label class="text-sm text-gray-500">Tunai (Rp)</label>
                  <input type="number" min="0" step="100" v-model.number="cash" class="w-full border rounded px-3 py-2" />
                </div>
                <div class="grid grid-cols-4 gap-2">
                  <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" @click="addCash(100000)">100K</button>
                  <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" @click="addCash(50000)">50K</button>
                  <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" @click="addCash(20000)">20K</button>
                  <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" @click="addCash(10000)">10K</button>
                  <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" @click="addCash(5000)">5K</button>
                  <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" @click="addCash(2000)">2K</button>
                  <button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" @click="addCash(1000)">1K</button>
                  <button class="px-2 py-1 rounded bg-indigo-50 text-indigo-700 hover:bg-indigo-100" @click="cash = total">Pas</button>
                </div>
                <div class="flex items-center justify-between">
                  <div>Kembali</div>
                  <div class="font-semibold tabular-nums">{{ formatIDR(change) }}</div>
                </div>
              </div>

              <!-- QRIS dynamic payload + QR image -->
              <div v-if="paymentMethod==='qris'" class="space-y-2">
                <div class="text-sm text-gray-500">QRIS</div>
                
                <div id="qris-box" class="rounded-lg border-2 border-dashed border-gray-300 p-4 flex flex-col items-center justify-center text-center">
                  <canvas id="qris-canvas" width="200" height="200" class="block"></canvas>
                  <img id="qris-img" class="hidden w-[200px] h-[200px]" alt="QRIS" />
                  <div class="mt-2 text-sm text-gray-600">Scan untuk bayar</div>
                  <div class="text-sm font-semibold">Nominal: {{ formatIDR(total) }}</div>
                </div>
                
              </div>

              <!-- Other notes -->
              <div v-if="paymentMethod==='other'" class="space-y-2">
                <label class="text-sm text-gray-500" for="other-note">Catatan (opsional)</label>
                <textarea id="other-note" v-model="otherNote" rows="2" class="w-full border rounded px-3 py-2" placeholder="Misal: debit BCA, transfer, dsb."></textarea>
              </div>

              <button class="w-full mt-2 px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-50"
                :disabled="total===0 || (paymentMethod==='cash' && cash < total)"
                @click="confirmPayment">Konfirmasi Bayar</button>
            </div>
          </div>
        </div>

        <!-- Receipt Modal (full-screen) -->
        <div v-if="showReceiptModal" class="fixed inset-0 z-40 flex items-center justify-center bg-black/50 p-4">
          <div class="bg-white rounded-xl shadow p-4 w-full max-w-sm">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Struk</h3>
              <div class="flex items-center gap-2">
                <button class="p-2 rounded bg-green-600 hover:bg-green-700 text-white disabled:opacity-50" @click="shareReceiptWA" :disabled="!hasPrintableReceipt" aria-label="Bagikan WhatsApp">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M20 12c0 4.418-3.582 8-8 8a7.95 7.95 0 01-4.03-1.086L4 20l1.086-3.97A7.95 7.95 0 014 12c0-4.418 3.582-8 8-8s8 3.582 8 8zm-8-6.5a6.5 6.5 0 00-5.657 9.743l.245.437-.64 2.342 2.377-.623.423.25A6.5 6.5 0 1012 5.5zm3.29 8.7c-.18-.09-1.06-.52-1.22-.58-.16-.06-.28-.09-.4.09-.12.18-.46.58-.56.7-.1.12-.2.14-.38.05-.18-.09-.76-.28-1.45-.9-.54-.48-.9-1.08-1-1.26-.1-.18-.01-.28.08-.37.08-.08.18-.2.27-.3.09-.1.12-.18.18-.3.06-.12.03-.22-.01-.31-.04-.09-.4-.96-.55-1.32-.15-.36-.29-.31-.4-.31-.1 0-.22-.02-.34-.02-.12 0-.31.04-.47.22-.16.18-.62.6-.62 1.46 0 .86.64 1.69.72 1.81.09.12 1.26 1.92 3.06 2.69.43.18.76.28 1.02.36.43.14.83.12 1.14.07.35-.05 1.06-.43 1.21-.85.15-.42.15-.78.11-.85-.04-.07-.16-.11-.34-.2z"/></svg>
                </button>
                <button class="p-2 rounded bg-indigo-600 hover:bg-indigo-700 text-white" @click="printReceipt" :disabled="!hasPrintableReceipt" aria-label="Cetak">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6 2a2 2 0 00-2 2v3h12V4a2 2 0 00-2-2H6z"/><path fill-rule="evenodd" d="M4 9a2 2 0 00-2 2v3a2 2 0 002 2h1v-2a2 2 0 012-2h6a2 2 0 012 2v2h1a2 2 0 002-2v-3a2 2 0 00-2-2H4zm4 7h4v-2H8v2z" clip-rule="evenodd"/></svg>
                </button>
                <button class="p-2 rounded hover:bg-gray-100" @click="showReceiptModal=false" aria-label="Tutup">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.536-10.95a1 1 0 00-1.414-1.414L10 7.586 7.879 5.465A1 1 0 106.465 6.88L8.586 9l-2.121 2.121a1 1 0 101.414 1.415L10 10.414l2.121 2.122a1 1 0 001.415-1.415L11.414 9l2.122-2.121z" clip-rule="evenodd"/></svg>
                </button>
              </div>
            </div>
            <div class="mt-3 flex justify-center">
              <div id="receipt" class="printable border rounded p-3 shadow-sm">
                <div class="text-center title">{{ storeName }}</div>
                <div class="text-center text-xs">{{ storeAddress }}</div>
                <div class="text-center text-xs">Telp: {{ storePhone }}</div>
                <div class="my-2 border-t border-dashed"></div>

                <div class="text-xs">Waktu: {{ formatDateTime(currentReceipt.date) }}</div>
                <div class="text-xs">ID: {{ currentReceipt.id || '-' }}</div>
                <div class="my-2 border-t border-dashed"></div>

                <div>
                  <div v-for="(it, i) in currentReceipt.items" :key="i" class="text-xs">
                    <div class="flex justify-between">
                      <div class="pr-2">{{ it.name }} Ã— {{ it.qty }}</div>
                      <div class="tabular-nums">{{ formatIDR(it.price * it.qty) }}</div>
                    </div>
                  </div>
                </div>

                <div class="my-2 border-t border-dashed"></div>
                <div class="text-xs flex justify-between"><span>Subtotal</span><span class="tabular-nums">{{ formatIDR(currentReceipt.subtotal || 0) }}</span></div>
                <div class="text-xs flex justify-between"><span>Diskon {{ (currentReceipt.discountPct||0) }}%</span><span class="tabular-nums">-{{ formatIDR(currentReceipt.discountAmount || 0) }}</span></div>
                <div class="text-xs flex justify-between"><span>Pajak {{ (currentReceipt.taxPct||0) }}%</span><span class="tabular-nums">{{ formatIDR(currentReceipt.taxAmount || 0) }}</span></div>
                <div class="text-xs flex justify-between font-semibold"><span>Total</span><span class="tabular-nums">{{ formatIDR(currentReceipt.total || 0) }}</span></div>
                <div class="text-xs flex justify-between"><span>Metode</span><span>{{ paymentLabel(currentReceipt.paymentMethod) }}</span></div>
                <div v-if="currentReceipt.paymentNote" class="text-xs flex justify-between"><span>Catatan</span><span>{{ currentReceipt.paymentNote }}</span></div>
                <div class="text-xs flex justify-between"><span>Bayar</span><span class="tabular-nums">{{ formatIDR(currentReceipt.paid || 0) }}</span></div>
                <div class="text-xs flex justify-between"><span>Kembali</span><span class="tabular-nums">{{ formatIDR(currentReceipt.change || 0) }}</span></div>

                <div class="my-2 border-t border-dashed"></div>
                <div class="text-center text-xs">Terima kasih</div>
              </div>
            </div>
          </div>
        </div>
      </main>
      
      <!-- Settings Modal -->
      <div v-if="showSettings" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white rounded-xl shadow p-4 w-full max-w-md max-h-[85vh] overflow-y-auto">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Pengaturan Toko</h3>
            <button @click="showSettings=false" class="p-2 rounded hover:bg-gray-100" aria-label="Tutup">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.536-10.95a1 1 0 00-1.414-1.414L10 7.586 7.879 5.465A1 1 0 106.465 6.88L8.586 9l-2.121 2.121a1 1 0 101.414 1.415L10 10.414l2.121 2.122a1 1 0 001.415-1.415L11.414 9l2.122-2.121z" clip-rule="evenodd"/></svg>
            </button>
          </div>
          <div class="space-y-3">
            <div>
              <label class="text-sm text-gray-600">Judul/ Nama Toko</label>
              <input v-model="storeName" class="w-full border rounded px-3 py-2" placeholder="Kasir Mini" />
            </div>
            <div>
              <label class="text-sm text-gray-600">Alamat</label>
              <textarea v-model="storeAddress" rows="2" class="w-full border rounded px-3 py-2" placeholder="Alamat"></textarea>
            </div>
            <div>
              <label class="text-sm text-gray-600">Telepon</label>
              <input v-model="storePhone" class="w-full border rounded px-3 py-2" placeholder="0800-000-000" />
            </div>
            <div>
              <label class="text-sm text-gray-600">QRIS Payload Dasar</label>
              <textarea v-model="qrisBase" rows="3" class="w-full border rounded px-3 py-2" placeholder="000201..."></textarea>
              <p class="text-xs text-gray-500 mt-1">Nominal dan CRC akan dihitung otomatis saat pembayaran.</p>
            </div>
            <div class="pt-1">
              <h4 class="font-medium text-sm mb-1">Backup ke Google Sheets</h4>
              <div class="space-y-2">
                <div>
                  <label class="text-xs text-gray-600">Apps Script Web App URL</label>
                  <input v-model.trim="gsWebAppUrl" class="w-full border rounded px-3 py-2" placeholder="https://script.google.com/macros/s/AKfycb.../exec" />
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                  <div>
                    <label class="text-xs text-gray-600">Spreadsheet ID</label>
                    <input v-model.trim="gsSheetId" class="w-full border rounded px-3 py-2" placeholder="1AbC..." />
                  </div>
                  <div>
                    <label class="text-xs text-gray-600">Sheet Name</label>
                    <input v-model.trim="gsSheetName" class="w-full border rounded px-3 py-2" placeholder="Backup" />
                  </div>
                </div>
                <div>
                  <label class="text-xs text-gray-600">Secret Token (opsional)</label>
                  <input v-model.trim="gsSecret" class="w-full border rounded px-3 py-2" placeholder="mis. rahasia-123" />
                  <p class="text-xs text-gray-500 mt-1">Set juga APP_SECRET di Apps Script agar request tidak sembarang.</p>
                </div>
                <label class="inline-flex items-center gap-2 text-sm">
                  <input type="checkbox" v-model="gsUseColumns" />
                  Simpan per kolom (bukan JSON)
                </label>
                <label class="inline-flex items-center gap-2 text-sm">
                  <input type="checkbox" v-model="autoBackup" />
                  Auto backup setelah pembayaran
                </label>
                <p class="text-xs text-gray-500">Ganti Spreadsheet ID kapan saja untuk backup/restore ke file berbeda.</p>
              </div>
            </div>
            <div class="flex justify-end gap-2 pt-2">
              <button @click="showSettings=false" class="px-3 py-2 rounded border">Batal</button>
              <button @click="testGsConnection" class="px-3 py-2 rounded bg-amber-500 text-white" :disabled="testBusy">{{ testBusy ? 'Menguji...' : 'Test Koneksi' }}</button>
              <button @click="saveSettings(); showSettings=false" class="px-3 py-2 rounded bg-indigo-600 text-white">Simpan</button>
            </div>
            <div v-if="testStatus" class="mt-2 text-xs" :class="testOk ? 'text-emerald-700' : 'text-rose-700'">{{ testStatus }}</div>

            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
             
              <button @click="exportSettingsFileTxt" class="px-3 py-2 rounded border">Ekspor Pengaturan (.txt)</button>
             
            </div>
          </div>
        </div>
      </div>

      <!-- Scanner Modal -->
      <div v-if="showScanner" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
        <div class="bg-white rounded-xl shadow p-4 w-full max-w-sm">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Scan Barcode</h3>
            <button @click="closeScanner" class="p-2 rounded hover:bg-gray-100" aria-label="Tutup">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.536-10.95a1 1 0 00-1.414-1.414L10 7.586 7.879 5.465A1 1 0 106.465 6.88L8.586 9l-2.121 2.121a1 1 0 101.414 1.415L10 10.414l2.121 2.122a1 1 0 001.415-1.415L11.414 9l2.122-2.121z" clip-rule="evenodd"/></svg>
            </button>
          </div>
          <div class="rounded overflow-hidden">
            <video id="scan-video" class="w-full max-h-80 bg-black" playsinline></video>
          </div>
          <div class="text-xs text-gray-500 mt-2">Arahkan kamera ke barcode produk.</div>
          <div v-if="scanError" class="text-xs text-red-600 mt-1">{{ scanError }}</div>
        </div>
      </div>

      
    </div>

    <!-- Dexie CDN (global Dexie) -->
    <script src="https://unpkg.com/dexie@3.2.5/dist/dexie.min.js"></script>
    <!-- QR code generator (browser UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- html2canvas for screenshotting receipt (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- Vue 3 ESM -->
    <script type="module">
      import { createApp, ref, reactive, computed, onMounted, nextTick, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js';

      // Currency util for IDR
      const idr = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 });

      // IndexedDB via Dexie (products) and Native helper (transactions)
      const db = new window.Dexie('kasirmini');
      db.version(1).stores({ transactions: '++id, date' });
      db.version(2).stores({ transactions: '++id, date', products: '++id, name, barcode' });

      // Lightweight IndexedDB helper (no external lib) for transactions
      const idbTx = (() => {
        let dbp = null;
        function open(){
          if (dbp) return dbp;
          dbp = new Promise((resolve, reject) => {
            const req = indexedDB.open('kasirmini_native', 1);
            req.onupgradeneeded = () => {
              const idb = req.result;
              if (!idb.objectStoreNames.contains('transactions')){
                const store = idb.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                try { store.createIndex('date', 'date', { unique: false }); } catch {}
              }
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
          });
          return dbp;
        }
        async function add(doc){
          const idb = await open();
          return new Promise((resolve, reject) => {
            const tx = idb.transaction('transactions', 'readwrite');
            const store = tx.objectStore('transactions');
            const req = store.add(doc);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
          });
        }
        async function putMany(list){
          const idb = await open();
          return new Promise((resolve, reject) => {
            const tx = idb.transaction('transactions', 'readwrite');
            const store = tx.objectStore('transactions');
            for (const doc of list){ store.put(doc); }
            tx.oncomplete = () => resolve(true);
            tx.onerror = () => reject(tx.error);
          });
        }
        async function getAllDesc(){
          const idb = await open();
          return new Promise((resolve, reject) => {
            const tx = idb.transaction('transactions', 'readonly');
            const store = tx.objectStore('transactions');
            let results = [];
            let req;
            try {
              const idx = store.index('date');
              req = idx.openCursor(null, 'prev');
            } catch {
              req = store.openCursor(null, 'prev');
            }
            req.onsuccess = (e) => {
              const cursor = e.target.result;
              if (cursor){ results.push(cursor.value); cursor.continue(); }
              else resolve(results);
            };
            req.onerror = () => reject(req.error);
          });
        }
        return { open, add, putMany, getAllDesc };
      })();

      async function migrateDexieTransactionsOnce(){
        try {
          const native = await idbTx.getAllDesc();
          if (native && native.length) return; // already migrated/has data
          if (window.Dexie && db?.transactions){
            const legacy = await db.transactions.toArray();
            if (legacy && legacy.length){
              // Preserve IDs when possible
              const toPut = legacy.map(x => ({ ...x }));
              await idbTx.putMany(toPut);
            }
          }
        } catch {}
      }

      const app = createApp({
        setup() {
          const newItem = reactive({ name: '', price: null });
          const cart = ref([]);
          const discountPct = ref(0);
          const taxPct = ref(0);

          const subtotal = computed(() => cart.value.reduce((s, it) => s + (Number(it.price)||0) * (Number(it.qty)||0), 0));
          const discountAmount = computed(() => Math.floor(subtotal.value * (Number(discountPct.value)||0) / 100));
          const taxable = computed(() => Math.max(0, subtotal.value - discountAmount.value));
          const taxAmount = computed(() => Math.floor(taxable.value * (Number(taxPct.value)||0) / 100));
          const total = computed(() => Math.max(0, taxable.value + taxAmount.value));

          const activeTab = ref('pos');
          const showPayment = ref(false);
          const paymentMethod = ref('cash'); // 'cash' | 'qris' | 'other'
          const showReceiptModal = ref(false);
          const showSettings = ref(false);
          const showFirstRunImport = ref(false);
          const storeName = ref('Kasir Mini');
          const storeAddress = ref('Jl. Contoh No. 123');
          const storePhone = ref('0800-000-000');
          const cash = ref(0);
          const change = computed(() => paymentMethod.value==='cash' ? Math.max(0, (Number(cash.value)||0) - total.value) : 0);
          const otherNote = ref('');
          const qrisBase = ref('00020101021126570011ID.DANA.WWW011893600915323576397902092357639790303UMI51440014ID.CO.QRIS.WWW0215ID10221538453370303UMI5204504553033605802ID5908EL-M.net6013Kab. Pasuruan6105671516304280A');

          // Google Sheets backup settings
          const gsWebAppUrl = ref('');
          const gsSheetId = ref('');
          const gsSheetName = ref('Backup');
          const gsSecret = ref('');
          const gsUseColumns = ref(false);
          const autoBackup = ref(false);
          const backupStatus = ref('');
          const backupStatusOk = ref(true);
          const testStatus = ref('');
          const testOk = ref(false);
          const testBusy = ref(false);

          const SETTINGS_KEY = 'kasirmini_settings_v1';
          function loadSettings(){
            try {
              const raw = localStorage.getItem(SETTINGS_KEY);
              if (!raw) return false;
              const s = JSON.parse(raw);
              if (s.storeName) storeName.value = s.storeName;
              if (s.storeAddress) storeAddress.value = s.storeAddress;
              if (s.storePhone) storePhone.value = s.storePhone;
              if (s.qrisBase) qrisBase.value = s.qrisBase;
              if (s.gsWebAppUrl) gsWebAppUrl.value = s.gsWebAppUrl;
              if (s.gsSheetId) gsSheetId.value = s.gsSheetId;
              if (s.gsSheetName) gsSheetName.value = s.gsSheetName;
              if (s.gsSecret) gsSecret.value = s.gsSecret;
              if (typeof s.gsUseColumns === 'boolean') gsUseColumns.value = s.gsUseColumns;
              if (typeof s.autoBackup === 'boolean') autoBackup.value = s.autoBackup;
              return true;
            } catch { return false; }
          }
          function saveSettings(){
            const s = {
              storeName: storeName.value,
              storeAddress: storeAddress.value,
              storePhone: storePhone.value,
              qrisBase: qrisBase.value,
              gsWebAppUrl: gsWebAppUrl.value,
              gsSheetId: gsSheetId.value,
              gsSheetName: gsSheetName.value,
              gsSecret: gsSecret.value,
              gsUseColumns: gsUseColumns.value,
              autoBackup: autoBackup.value,
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
          }
          function getSettingsObject(){
            return {
              storeName: storeName.value,
              storeAddress: storeAddress.value,
              storePhone: storePhone.value,
              qrisBase: qrisBase.value,
              gsWebAppUrl: gsWebAppUrl.value,
              gsSheetId: gsSheetId.value,
              gsSheetName: gsSheetName.value,
              gsSecret: gsSecret.value,
              gsUseColumns: gsUseColumns.value,
              autoBackup: autoBackup.value,
              _ts: new Date().toISOString(),
              _ver: '1',
            };
          }
          function applySettingsObject(obj){
            if (!obj || typeof obj !== 'object') return;
            if (obj.storeName !== undefined) storeName.value = obj.storeName;
            if (obj.storeAddress !== undefined) storeAddress.value = obj.storeAddress;
            if (obj.storePhone !== undefined) storePhone.value = obj.storePhone;
            if (obj.qrisBase !== undefined) qrisBase.value = obj.qrisBase;
            if (obj.gsWebAppUrl !== undefined) gsWebAppUrl.value = obj.gsWebAppUrl;
            if (obj.gsSheetId !== undefined) gsSheetId.value = obj.gsSheetId;
            if (obj.gsSheetName !== undefined) gsSheetName.value = obj.gsSheetName;
            if (obj.gsSecret !== undefined) gsSecret.value = obj.gsSecret;
            if (obj.gsUseColumns !== undefined) gsUseColumns.value = !!obj.gsUseColumns;
            if (obj.autoBackup !== undefined) autoBackup.value = !!obj.autoBackup;
            saveSettings();
          }

          // Export/Import settings via file
          function exportSettingsFile(){
            try{
              const obj = getSettingsObject();
              const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
              a.download = `kasirmini-settings-${ts}.json`;
              document.body.appendChild(a); a.click(); document.body.removeChild(a);
              URL.revokeObjectURL(url);
              testStatus.value = 'Pengaturan diekspor'; testOk.value = true;
            } catch(e){ testStatus.value = 'Gagal ekspor: ' + (e?.message||''); testOk.value=false; }
          }
          function exportSettingsFileTxt(){
            try{
              const obj = getSettingsObject();
              const blob = new Blob([JSON.stringify(obj)], { type: 'text/plain' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
              a.download = `kasirmini-settings-${ts}.txt`;
              document.body.appendChild(a); a.click(); document.body.removeChild(a);
              URL.revokeObjectURL(url);
              testStatus.value = 'Pengaturan diekspor (.txt)'; testOk.value = true;
            } catch(e){ testStatus.value = 'Gagal ekspor txt: ' + (e?.message||''); testOk.value=false; }
          }
          async function importSettingsFile(ev){
            try{
              const file = ev?.target?.files?.[0]; if (!file) return;
              await importSettingsFromFile(file);
              testStatus.value = 'Pengaturan diimpor'; testOk.value = true;
            } catch(e){ testStatus.value = 'Gagal impor: ' + (e?.message||''); testOk.value = false; }
            finally { try { ev.target.value = ''; } catch {} }
          }
          async function importSettingsFromFile(file){
            const text = await file.text();
            let obj = null;
            try { obj = JSON.parse(text); }
            catch { throw new Error('Format file tidak valid, harap JSON'); }
            applySettingsObject(obj);
            showFirstRunImport.value = false;
          }

          function openImportSettingsPicker(){
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json,text/plain';
            input.onchange = async (e) => {
              try{
                const file = e.target.files && e.target.files[0]; if (!file) return;
                await importSettingsFromFile(file);
                alert('Pengaturan berhasil diimpor.');
              } catch(err){ alert('Gagal impor: ' + (err?.message||'')); }
            };
            document.body.appendChild(input);
            input.click();
            setTimeout(() => { try { document.body.removeChild(input); } catch {} }, 0);
          }

          // Backup/Restore settings via Apps Script
          async function backupSettingsToSheet(){
            try{
              if (!gsWebAppUrl.value || !gsSheetId.value) throw new Error('Isi URL & Spreadsheet ID');
              const payload = { action:'settings_put', sheetId: gsSheetId.value, sheetName: 'Config', name: 'default', settings: getSettingsObject() };
              const resp = await appsScriptCall(payload);
              if (resp?.ok) { testStatus.value = 'Backup pengaturan sukses'; testOk.value = true; }
              else { throw new Error('Respon gagal'); }
            } catch(e){ testStatus.value = 'Gagal backup pengaturan: ' + (e?.message||''); testOk.value = false; }
          }
          async function restoreSettingsFromSheet(){
            try{
              if (!gsWebAppUrl.value || !gsSheetId.value) throw new Error('Isi URL & Spreadsheet ID');
              const payload = { action:'settings_get', sheetId: gsSheetId.value, sheetName: 'Config', name: 'default' };
              const resp = await appsScriptCall(payload);
              const s = resp?.settings;
              if (!s || typeof s !== 'object') throw new Error('Tidak menemukan pengaturan di Sheet');
              applySettingsObject(s);
              testStatus.value = 'Restore pengaturan sukses'; testOk.value = true;
            } catch(e){ testStatus.value = 'Gagal restore pengaturan: ' + (e?.message||''); testOk.value = false; }
          }

          // QRIS helpers and computed payload
          function stripCRC(payload){
            const idx = payload.indexOf('6304');
            return idx !== -1 ? payload.slice(0, idx) : payload;
          }
          function removeTag(payload, tag){
            let i = 0;
            while (i < payload.length - 4){
              const t = payload.slice(i, i+2);
              const len = parseInt(payload.slice(i+2, i+4), 10);
              const valStart = i+4;
              const valEnd = valStart + len;
              if (t === tag){
                return payload.slice(0, i) + payload.slice(valEnd);
              }
              i = valEnd;
            }
            return payload;
          }
          function insertAmount(payloadNoCRC, amount){
            const amtStr = String(amount);
            const len = amtStr.length.toString().padStart(2,'0');
            const cleaned = removeTag(payloadNoCRC, '54');
            return cleaned + '54' + len + amtStr;
          }
          function crc16ccitt(str){
            let crc = 0xFFFF;
            for (let i=0; i<str.length; i++){
              crc ^= str.charCodeAt(i) << 8;
              for (let j=0;j<8;j++){
                if (crc & 0x8000) crc = (crc << 1) ^ 0x1021; else crc <<= 1;
                crc &= 0xFFFF;
              }
            }
            return crc.toString(16).toUpperCase().padStart(4,'0');
          }
          const qrisPayloadFinal = computed(() => {
            try {
              const baseNoCRC = stripCRC((qrisBase.value||'').trim());
              const withAmount = insertAmount(baseNoCRC, total.value);
              const toCRC = withAmount + '6304';
              const crc = crc16ccitt(toCRC);
              return withAmount + '6304' + crc;
            } catch (e){ return qrisBase.value; }
          });

          // Render QR when method, total, payload, or modal state changes
          async function renderQRIS() {
            await nextTick();
            const canvas = document.getElementById('qris-canvas');
            const img = document.getElementById('qris-img');
            if (!canvas || !img) return;
            const data = qrisPayloadFinal.value || '';
            if (window.QRCode) {
              // Prefer canvas render
              try {
                await window.QRCode.toCanvas(canvas, data, { width: 200, margin: 1 });
                canvas.classList.remove('hidden');
                img.classList.add('hidden');
              } catch (e) {
                // fallback to external API image
                img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(data);
                img.classList.remove('hidden');
                canvas.classList.add('hidden');
              }
            } else {
              // Fallback if QRCode lib not loaded
              img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(data);
              img.classList.remove('hidden');
              canvas.classList.add('hidden');
            }
          }
          watch([paymentMethod, total, qrisBase, showPayment], async () => {
            if (showPayment.value && paymentMethod.value==='qris') {
              await renderQRIS();
            }
          }, { immediate: false });

          const history = ref([]);
          const historyQuery = ref('');
          const historyMethod = ref('');
          const products = ref([]);
          const newProduct = reactive({ id: null, name: '', price: null, barcode: '' });
          const productQuery = ref('');
          const showScanner = ref(false);
          const scanError = ref('');
          const filterStart = ref('');
          const filterEnd = ref('');

          const lastReceipt = ref(null);

          const hasPrintableReceipt = computed(() => (cart.value.length > 0) || !!lastReceipt.value);
          const filteredProducts = computed(() => {
            const q = (productQuery.value||'').toLowerCase().trim();
            if (!q) return products.value.slice(0, 20);
            return products.value.filter(p => (p.name||'').toLowerCase().includes(q) || (p.barcode||'').includes(q)).slice(0, 50);
          });

          const currentReceipt = computed(() => {
            if (cart.value.length > 0) {
              return {
                date: new Date().toISOString(),
                id: null,
                items: cart.value.map(i => ({ name: i.name, price: Number(i.price)||0, qty: Number(i.qty)||0 })),
                subtotal: subtotal.value,
                discountPct: Number(discountPct.value)||0,
                discountAmount: discountAmount.value,
                taxPct: Number(taxPct.value)||0,
                taxAmount: taxAmount.value,
                total: total.value,
                paymentMethod: paymentMethod.value,
                paymentNote: paymentMethod.value==='other' ? (otherNote.value||'') : '',
                paid: Number(cash.value)||0,
                change: change.value,
              };
            }
            return lastReceipt.value || { items: [], total: 0 };
          });

          function formatIDR(n){ return idr.format(Number(n)||0); }
          function formatDateTime(iso){ if (!iso) return '-'; const d = new Date(iso); return d.toLocaleString('id-ID'); }

          function addItem(){
            const name = (newItem.name||'').trim();
            const price = Math.max(0, Number(newItem.price)||0);
            if (!name || price <= 0) return;
            const idx = cart.value.findIndex(x => x.name===name && Number(x.price)===price);
            if (idx >= 0) cart.value[idx].qty += 1; else cart.value.push({ name, price, qty: 1 });
            newItem.name=''; newItem.price=null;
          }
          function incQty(i){ cart.value[i].qty += 1; }
          function decQty(i){ cart.value[i].qty = Math.max(1, Number(cart.value[i].qty)||1); if (cart.value[i].qty>1) cart.value[i].qty -= 1; }
          function removeItem(i){ cart.value.splice(i,1); }
          function clearCart(){ cart.value = []; cash.value = 0; }
          function addProductToCart(p){
            const idx = cart.value.findIndex(x => x.name===p.name && Number(x.price)===Number(p.price));
            if (idx >= 0) cart.value[idx].qty += 1; else cart.value.push({ name: p.name, price: Number(p.price)||0, qty: 1 });
          }

          function openPayment(){ showPayment.value = true; if (paymentMethod.value==='cash') cash.value = total.value; }

          async function confirmPayment(){
            if (paymentMethod.value === 'cash' && cash.value < total.value) return;
            const tx = {
              date: new Date().toISOString(),
              items: cart.value.map(i => ({ name: i.name, price: Number(i.price)||0, qty: Number(i.qty)||0 })),
              subtotal: subtotal.value,
              discountPct: Number(discountPct.value)||0,
              discountAmount: discountAmount.value,
              taxPct: Number(taxPct.value)||0,
              taxAmount: taxAmount.value,
              total: total.value,
              paymentMethod: paymentMethod.value,
              paymentNote: paymentMethod.value==='other' ? (otherNote.value||'') : '',
              paid: paymentMethod.value==='cash' ? (Number(cash.value)||0) : total.value,
              change: paymentMethod.value==='cash' ? change.value : 0,
            };
            const id = await idbTx.add(tx);
            tx.id = id;
            lastReceipt.value = tx;
            await loadHistory();
            showPayment.value = false;
            clearCart();
            activeTab.value = 'pos';
            showReceiptModal.value = true; // auto show receipt
            // reset transient fields
            otherNote.value = '';
            if (paymentMethod.value !== 'cash') cash.value = 0;

            // Optional auto backup single transaction
            if (autoBackup.value) {
              try { await backupToSheet([tx]); } catch {}
            }
          }

          async function loadHistory(){
            await migrateDexieTransactionsOnce();
            const all = await idbTx.getAllDesc();
            history.value = all;
          }
          async function loadProducts(){ products.value = await db.products.toArray(); }
          async function saveProduct(){
            const name = (newProduct.name||'').trim();
            const price = Math.max(0, Number(newProduct.price)||0);
            const barcode = (newProduct.barcode||'').trim();
            if (!name || price<=0) return;
            if (newProduct.id){
              await db.products.update(newProduct.id, { name, price, barcode });
            } else {
              await db.products.add({ name, price, barcode });
            }
            Object.assign(newProduct, { id:null, name:'', price:null, barcode:'' });
            await loadProducts();
          }
          function editProduct(p){ Object.assign(newProduct, p); }
          async function deleteProduct(id){ await db.products.delete(id); await loadProducts(); }

          // ===== Backup/Restore Products =====
          function serializeProduct(p){
            return { id: p.id ?? null, name: p.name||'', price: Number(p.price)||0, barcode: p.barcode||'' };
          }
          async function exportProductsJSON(){
            try{
              const list = await db.products.toArray();
              const data = list.map(serializeProduct);
              const blob = new Blob([JSON.stringify({ _type:'products', version:1, items:data }, null, 2)], { type:'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url; const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
              a.download = `produk-${ts}.json`;
              document.body.appendChild(a); a.click(); document.body.removeChild(a);
              URL.revokeObjectURL(url);
              backupStatus.value = 'Ekspor produk selesai'; backupStatusOk.value = true;
            } catch(e){ backupStatus.value = 'Gagal ekspor produk: ' + (e?.message||''); backupStatusOk.value=false; }
          }
          async function importProductsJSON(ev){
            try{
              const file = ev?.target?.files?.[0]; if (!file) return;
              const text = await file.text();
              const obj = JSON.parse(text);
              const items = Array.isArray(obj?.items) ? obj.items : (Array.isArray(obj) ? obj : []);
              if (!items.length) throw new Error('File kosong');
              const doReplace = confirm('Impor produk? OK=Replace semua, Cancel=Merge');
              if (doReplace) {
                await db.products.clear();
              }
              // Use bulkPut to insert/overwrite by id if available
              const toPut = items.map(x => ({ id: x.id, name: String(x.name||''), price: Number(x.price)||0, barcode: String(x.barcode||'') }));
              await db.products.bulkPut(toPut);
              await loadProducts();
              backupStatus.value = 'Impor produk selesai'; backupStatusOk.value = true;
            } catch(e){ backupStatus.value = 'Gagal impor produk: ' + (e?.message||''); backupStatusOk.value=false; }
            finally { try { ev.target.value = ''; } catch {} }
          }
          async function backupProductsToSheet(){
            try{
              const list = await db.products.toArray();
              const rows = list.map(serializeProduct);
              if (!rows.length) { backupStatus.value = 'Tidak ada produk untuk backup'; backupStatusOk.value=true; return; }
              const payload = { action:'products_put', sheetId: gsSheetId.value, sheetName: 'Products', format: gsUseColumns.value ? 'columns' : 'json', rows };
              const resp = await appsScriptCall(payload);
              if (resp?.ok) { backupStatus.value = `Backup produk sukses: ${resp.inserted ?? rows.length}`; backupStatusOk.value=true; }
              else { throw new Error('Respon gagal'); }
            } catch(e){ backupStatus.value = 'Backup produk gagal: ' + (e?.message||''); backupStatusOk.value=false; }
          }
          async function restoreProductsFromSheet(replace=false){
            try{
              const payload = { action:'products_list', sheetId: gsSheetId.value, sheetName: 'Products', format: gsUseColumns.value ? 'columns' : 'json' };
              const resp = await appsScriptCall(payload);
              const items = Array.isArray(resp?.rows) ? resp.rows : [];
              if (!items.length) { backupStatus.value = 'Tidak ada produk di Sheet'; backupStatusOk.value=false; return; }
              if (replace) await db.products.clear();
              const toPut = items.map(x => ({ id: x.id, name: String(x.name||''), price: Number(x.price)||0, barcode: String(x.barcode||'') }));
              await db.products.bulkPut(toPut);
              await loadProducts();
              backupStatus.value = `Restore produk selesai: ${toPut.length}`; backupStatusOk.value=true;
            } catch(e){ backupStatus.value = 'Restore produk gagal: ' + (e?.message||''); backupStatusOk.value=false; }
          }
          async function restoreProductsFromSheetUI(){
            const doReplace = confirm('Restore produk dari Sheet? OK=Replace semua, Cancel=Merge');
            await restoreProductsFromSheet(!!doReplace);
          }

          // Scanner
          let codeReader = null;
          let mediaStream = null;
          let scanningActive = false;
          async function openScanner(){
            scanError.value=''; showScanner.value = true;
            await nextTick();
            const video = document.getElementById('scan-video');
            try {
              // Always request camera to trigger permission prompt
              mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false });
              video.srcObject = mediaStream;
              await video.play();

              // Prefer native BarcodeDetector if available
              if ('BarcodeDetector' in window) {
                const formats = ['ean_13','ean_8','code_128','code_39','upc_a','upc_e','itf','qr_code'];
                const detector = new window.BarcodeDetector({ formats });
                scanningActive = true;
                const loop = async () => {
                  if (!scanningActive) return;
                  try {
                    const codes = await detector.detect(video);
                    if (codes && codes.length) {
                      const code = (codes[0].rawValue || codes[0].raw || '').trim();
                      if (code) {
                        const found = await db.products.where('barcode').equals(code).first();
                        if (found) addProductToCart(found); else scanError.value = `Barcode tidak dikenal: ${code}`;
                        await closeScanner();
                        return;
                      }
                    }
                  } catch {}
                  requestAnimationFrame(loop);
                };
                requestAnimationFrame(loop);
                return;
              }

              // Fallback to ZXing library if available
              const ZX = window.ZXingBrowser || window.ZXing || {};
              const Reader = ZX.BrowserMultiFormatReader || (ZX.BrowserCodeReader && ZX.BrowserCodeReader);
              if (Reader) {
                codeReader = new Reader();
                await codeReader.decodeFromVideoDevice(undefined, video, async (result, err) => {
                  if (result && result.text) {
                    try {
                      const code = result.text.trim();
                      const found = await db.products.where('barcode').equals(code).first();
                      if (found) addProductToCart(found);
                      else scanError.value = `Barcode tidak dikenal: ${code}`;
                      await closeScanner();
                    } catch(e){ scanError.value = 'Gagal memproses barcode'; }
                  }
                });
                return;
              }

              scanError.value = 'Library pemindai tidak tersedia';
            } catch (e){
              scanError.value = (e && e.message) ? e.message : 'Gagal membuka kamera';
            }
          }
          async function closeScanner(){
            scanningActive = false;
            showScanner.value = false;
            try{ if (codeReader && codeReader.reset) codeReader.reset(); } catch {}
            codeReader = null;
            try {
              const video = document.getElementById('scan-video');
              if (video) { video.pause(); video.srcObject = null; }
              if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); }
            } catch {}
            mediaStream = null;
          }

          const filteredHistory = computed(() => {
            const start = filterStart.value ? new Date(filterStart.value + 'T00:00:00') : null;
            const end = filterEnd.value ? new Date(filterEnd.value + 'T23:59:59.999') : null;
            const method = (historyMethod.value||'').trim();
            const q = (historyQuery.value||'').toLowerCase();
            return history.value.filter(tx => {
              const d = new Date(tx.date);
              if (start && d < start) return false;
              if (end && d > end) return false;
              if (method && tx.paymentMethod !== method) return false;
              if (q){
                const idStr = String(tx.id||'');
                const note = (tx.paymentNote||'').toLowerCase();
                const itemsStr = (tx.items||[]).map(i => (i.name||'').toLowerCase()).join(' ');
                if (!(idStr.includes(q) || note.includes(q) || itemsStr.includes(q))) return false;
              }
              return true;
            });
          });

          const historySummary = computed(() => {
            const arr = filteredHistory.value;
            const totalSum = arr.reduce((s, t) => s + (Number(t.total)||0), 0);
            const count = arr.length;
            return { count, total: totalSum, avg: count ? Math.floor(totalSum / count) : 0 };
          });

          function resetHistoryFilters(){
            historyQuery.value = '';
            historyMethod.value = '';
            filterStart.value = '';
            filterEnd.value = '';
          }

          function exportHistoryCSV(){
            const rows = [];
            const header = ['id','date','total','paymentMethod','itemsCount','discountPct','taxPct','paid','change','paymentNote','items'];
            rows.push(header.join(','));
            for (const tx of filteredHistory.value){
              const itemsText = (tx.items||[]).map(i => `${(i.name||'').replaceAll('"','""')} x ${i.qty} @ ${i.price}`).join('; ');
              const cols = [
                tx.id ?? '',
                tx.date ?? '',
                tx.total ?? 0,
                tx.paymentMethod ?? '',
                (tx.items||[]).length,
                tx.discountPct ?? 0,
                tx.taxPct ?? 0,
                tx.paid ?? 0,
                tx.change ?? 0,
                (tx.paymentNote||'').replaceAll('"','""'),
                itemsText,
              ].map(v => typeof v === 'string' ? `"${v}"` : v);
              rows.push(cols.join(','));
            }
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
            a.download = `riwayat-${ts}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }

          // ===== Google Sheets Backup/Restore =====
          function serializeTx(tx){
            return {
              id: tx.id ?? null,
              date: tx.date ?? '',
              subtotal: Number(tx.subtotal)||0,
              discountPct: Number(tx.discountPct)||0,
              discountAmount: Number(tx.discountAmount)||0,
              taxPct: Number(tx.taxPct)||0,
              taxAmount: Number(tx.taxAmount)||0,
              total: Number(tx.total)||0,
              paymentMethod: tx.paymentMethod || '',
              paymentNote: tx.paymentNote || '',
              paid: Number(tx.paid)||0,
              change: Number(tx.change)||0,
              items: (tx.items||[]).map(i => ({ name: i.name||'', price: Number(i.price)||0, qty: Number(i.qty)||0 })),
            };
          }
          async function appsScriptCall(body){
            if (!gsWebAppUrl.value) throw new Error('Apps Script URL kosong');
            // Sertakan secret di body (tanpa custom header agar tidak preflight)
            const payload = { ...body };
            if (gsSecret.value) payload.secret = gsSecret.value;
            // Gunakan Content-Type sederhana agar tidak memicu preflight (CORS)
            const res = await fetch(gsWebAppUrl.value, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify(payload),
            });
            const text = await res.text().catch(()=>'');
            let data = null;
            try { data = text ? JSON.parse(text) : null; } catch {}
            if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} ${text||''}`.trim());
            if (!data) throw new Error(`Respon tidak valid: ${text?.slice(0,200)}`);
          return data;
          }
          async function testGsConnection(){
            testBusy.value = true; testStatus.value=''; testOk.value=false;
            try{
              if (!gsWebAppUrl.value || !gsSheetId.value) throw new Error('Isi URL & Spreadsheet ID');
              const resp = await appsScriptCall({ action:'list', format: gsUseColumns.value ? 'columns' : 'json', sheetId: gsSheetId.value, sheetName: gsSheetName.value||'Backup' });
              const count = Array.isArray(resp?.rows) ? resp.rows.length : 0;
              testStatus.value = `Terhubung. Rows: ${count}`; testOk.value = true;
            } catch(e){ testStatus.value = 'Gagal: ' + (e?.message||''); testOk.value = false; }
            finally { testBusy.value = false; }
          }
          async function backupToSheet(rows){
            backupStatus.value = 'Menyimpan ke Google Sheet...'; backupStatusOk.value = true;
            if (!gsWebAppUrl.value || !gsSheetId.value) {
              backupStatus.value = 'Konfigurasi Sheet belum lengkap'; backupStatusOk.value = false; return;
            }
            const payload = {
              action: 'append',
              sheetId: gsSheetId.value,
              sheetName: gsSheetName.value || 'Backup',
              format: gsUseColumns.value ? 'columns' : 'json',
              rows: rows.map(serializeTx),
            };
            try {
              const resp = await appsScriptCall(payload);
              if (resp && resp.ok) {
                backupStatus.value = `Backup sukses: ${resp.inserted ?? rows.length} baris`;
                backupStatusOk.value = true;
              } else {
                backupStatus.value = 'Backup gagal'; backupStatusOk.value = false;
              }
            } catch (e){ backupStatus.value = 'Backup gagal: ' + (e?.message||''); backupStatusOk.value = false; }
          }
          async function backupAllToSheet(){
            const rows = (typeof filteredHistory !== 'undefined' && filteredHistory?.value ? filteredHistory.value : (history.value || []));
            await backupToSheet(rows);
          }
          async function restoreFromSheet(replace=false){
            backupStatus.value = 'Mengambil data dari Google Sheet...'; backupStatusOk.value = true;
            if (!gsWebAppUrl.value || !gsSheetId.value) {
              backupStatus.value = 'Konfigurasi Sheet belum lengkap'; backupStatusOk.value = false; return;
            }
            try {
              const payload = { action: 'list', format: gsUseColumns.value ? 'columns' : 'json', sheetId: gsSheetId.value, sheetName: gsSheetName.value || 'Backup' };
              const resp = await appsScriptCall(payload);
              const rows = resp?.rows || resp?.transactions || [];
              if (!Array.isArray(rows)) { backupStatus.value = 'Format data tidak dikenali'; backupStatusOk.value = false; return; }
              const cleaned = rows.map(r => ({
                id: r.id ?? undefined,
                date: r.date,
                items: Array.isArray(r.items) ? r.items : [],
                subtotal: Number(r.subtotal)||0,
                discountPct: Number(r.discountPct)||0,
                discountAmount: Number(r.discountAmount)||0,
                taxPct: Number(r.taxPct)||0,
                taxAmount: Number(r.taxAmount)||0,
                total: Number(r.total)||0,
                paymentMethod: r.paymentMethod || '',
                paymentNote: r.paymentNote || '',
                paid: Number(r.paid)||0,
                change: Number(r.change)||0,
              }));

              if (replace) {
                // Clear and import all
                const idb = await idbTx.open();
                await new Promise((resolve, reject) => {
                  const tx = idb.transaction('transactions','readwrite');
                  tx.objectStore('transactions').clear();
                  tx.oncomplete = resolve; tx.onerror = () => reject(tx.error);
                });
                await idbTx.putMany(cleaned);
              } else {
                // Merge by skipping existing IDs
                const existing = await idbTx.getAllDesc();
                const existingIds = new Set((existing||[]).map(x => x.id).filter(v => v !== undefined && v !== null));
                const toPut = cleaned.filter(x => (x.id === undefined || x.id === null) ? true : !existingIds.has(x.id));
                if (toPut.length) await idbTx.putMany(toPut);
              }
              await loadHistory();
              backupStatus.value = `Restore selesai: ${cleaned.length} transaksi`;
              backupStatusOk.value = true;
            } catch (e){ backupStatus.value = 'Restore gagal: ' + (e?.message||''); backupStatusOk.value = false; }
          }
          async function restoreFromSheetUI(){
            const doReplace = confirm('Restore dari Sheet? OK=Replace semua, Cancel=Merge');
            await restoreFromSheet(!!doReplace);
          }

          function loadReceipt(tx){
            lastReceipt.value = JSON.parse(JSON.stringify(tx));
            showReceiptModal.value = true;
          }

          function addCash(amount){ cash.value = (Number(cash.value)||0) + amount; }
          function paymentLabel(m){ return m==='cash' ? 'Tunai' : (m==='qris' ? 'QRIS' : 'Lainnya'); }

          async function printReceipt(){
            if (!hasPrintableReceipt.value) return;
            if (!showReceiptModal.value) { showReceiptModal.value = true; await nextTick(); }
            window.print();
          }

          function buildReceiptText(r){
            const L = [];
            L.push(storeName.value);
            L.push(storeAddress.value);
            L.push('Telp: ' + storePhone.value);
            L.push('');
            L.push('Waktu: ' + formatDateTime(r.date));
            L.push('ID: ' + (r.id || '-'));
            L.push('');
            (r.items||[]).forEach(it => {
              L.push(`${it.name} x ${it.qty} - ${formatIDR((it.price||0)*(it.qty||0))}`);
            });
            L.push('');
            L.push('Subtotal: ' + formatIDR(r.subtotal||0));
            if ((r.discountAmount||0) > 0) L.push(`Diskon ${r.discountPct||0}%: -` + formatIDR(r.discountAmount||0));
            if ((r.taxAmount||0) > 0) L.push(`Pajak ${r.taxPct||0}%: ` + formatIDR(r.taxAmount||0));
            L.push('Total: ' + formatIDR(r.total||0));
            if (r.paymentMethod) L.push('Metode: ' + paymentLabel(r.paymentMethod));
            if (r.paymentNote) L.push('Catatan: ' + r.paymentNote);
            L.push('Bayar: ' + formatIDR(r.paid||0));
            L.push('Kembali: ' + formatIDR(r.change||0));
            L.push('');
            L.push('Terima kasih');
            return L.join('\n');
          }

          async function shareReceiptWA(){
            if (!hasPrintableReceipt.value) return;
            const r = currentReceipt.value || {};
            const text = buildReceiptText(r);
            let files = [];
            // Try to capture receipt as image if library available
            try {
              await nextTick();
              const el = document.getElementById('receipt');
              if (el && window.html2canvas) {
                const canvas = await window.html2canvas(el, { backgroundColor: '#fff', scale: 2, useCORS: true });
                const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.95));
                if (blob) {
                  files = [new File([blob], 'struk.png', { type: 'image/png' })];
                }
              }
            } catch {}

            if (navigator.share) {
              try {
                if (files.length && navigator.canShare && navigator.canShare({ files })) {
                  await navigator.share({ files, text });
                  return;
                }
                await navigator.share({ text });
                return;
              } catch {}
            }
            // Fallback to WhatsApp text share
            const wa = 'https://wa.me/?text=' + encodeURIComponent(text);
            window.open(wa, '_blank');
          }

      onMounted(async () => {
        await loadHistory();
        await loadProducts();
        const hadSettings = loadSettings();
        if (!hadSettings) showFirstRunImport.value = true;
        // Register service worker for offline
        if ('serviceWorker' in navigator) {
          try { await navigator.serviceWorker.register('./sw.js', { scope: './' }); } catch (e) { console.warn('SW register failed', e); }
        }
        // Hide loader after initial boot tasks
        try {
          const el = document.getElementById('app-loader');
          if (el) el.remove();
        } catch {}
      });

          return {
            // state
            newItem, cart, discountPct, taxPct,
            subtotal, discountAmount, taxable, taxAmount, total,
            activeTab, showPayment, paymentMethod, cash, change, otherNote,
            history, historyQuery, historyMethod, filterStart, filterEnd,
            lastReceipt, showReceiptModal,
            showSettings, showFirstRunImport, storeName, storeAddress, storePhone,
            products, newProduct, productQuery, filteredProducts,
            showScanner, scanError,
            qrisBase,
            gsWebAppUrl, gsSheetId, gsSheetName, gsSecret, gsUseColumns, autoBackup,
            backupStatus, backupStatusOk,
            testStatus, testOk, testBusy, testGsConnection,
            exportSettingsFileTxt, openImportSettingsPicker,

            // computed
            hasPrintableReceipt, currentReceipt, filteredHistory, historySummary,
            qrisPayloadFinal,

            // methods
            formatIDR, formatDateTime,
            addItem, incQty, decQty, removeItem, clearCart,
            openPayment, confirmPayment,
            loadReceipt, printReceipt,
            addCash, paymentLabel,
            loadSettings, saveSettings,
            shareReceiptWA,
            loadProducts, saveProduct, editProduct, deleteProduct,
            addProductToCart,
            exportProductsJSON, importProductsJSON,
            backupProductsToSheet, restoreProductsFromSheetUI,
            resetHistoryFilters, exportHistoryCSV,
            openScanner, closeScanner,
            backupAllToSheet, restoreFromSheetUI,
            };
        }
      });

      app.mount('#app');
    </script>
  </body>
  </html>
